<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>算法记录 | Yiiong's Blog</title><meta name="author" content="Yiiong"><meta name="copyright" content="Yiiong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="项目的组件放在internal&#x2F;​下  controller（控制器）：负责核心业务逻辑的调度和协调，监听 Kubernetes 中 IPBlock 自定义资源的变化，维护和管理其生命周期。  engine（封禁后端）：负责封禁命令的实际执行。  notify（通知机制）：负责将封禁、解封等事件以多种方式通知给运维人员或其他系统。  trigger（触发器）：事件触发中心，负责监听外部告警系统或业">
<meta property="og:type" content="article">
<meta property="og:title" content="算法记录">
<meta property="og:url" content="http://example.com/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="Yiiong&#39;s Blog">
<meta property="og:description" content="项目的组件放在internal&#x2F;​下  controller（控制器）：负责核心业务逻辑的调度和协调，监听 Kubernetes 中 IPBlock 自定义资源的变化，维护和管理其生命周期。  engine（封禁后端）：负责封禁命令的实际执行。  notify（通知机制）：负责将封禁、解封等事件以多种方式通知给运维人员或其他系统。  trigger（触发器）：事件触发中心，负责监听外部告警系统或业">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/ava.jpg">
<meta property="article:published_time" content="2025-12-08T14:00:22.521Z">
<meta property="article:modified_time" content="2025-12-08T14:11:53.715Z">
<meta property="article:author" content="Yiiong">
<meta property="article:tag" content="C">
<meta property="article:tag" content="数据结构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/ava.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "算法记录",
  "url": "http://example.com/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/",
  "image": "http://example.com/img/ava.jpg",
  "datePublished": "2025-12-08T14:00:22.521Z",
  "dateModified": "2025-12-08T14:11:53.715Z",
  "author": [
    {
      "@type": "Person",
      "name": "Yiiong",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/logo.svg"><link rel="canonical" href="http://example.com/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":"true`"},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Yiiong","link":"链接: ","source":"来源: Yiiong's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'FancyBox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '算法记录',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/universe.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div id="web_bg" style="background: transparent;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/tag.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Yiiong's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">算法记录</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">算法记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-08T14:00:22.521Z" title="发表于 2025-12-08 22:00:22">2025-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-08T14:11:53.715Z" title="更新于 2025-12-08 22:11:53">2025-12-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CS/">CS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>项目的组件放在<code>internal/</code>​下</p>
<ul>
<li><p>controller（控制器）：负责核心业务逻辑的调度和协调，监听 Kubernetes 中 IPBlock 自定义资源的变化，维护和管理其生命周期。</p>
</li>
<li><p>engine（封禁后端）：负责封禁命令的实际执行。</p>
</li>
<li><p>notify（通知机制）：负责将封禁、解封等事件以多种方式通知给运维人员或其他系统。</p>
</li>
<li><p>trigger（触发器）：事件触发中心，负责监听外部告警系统或业务事件（如 Grafana Alert等），并根据 Alert 策略触发相关封禁操作，自动创建 IPBlock CR，且支持自动解封。</p>
</li>
<li><p>policy（封禁策略）：定义 IP 封禁的判定规则和执行策略。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### 介绍</span><br><span class="line"></span><br><span class="line">封禁后端均被抽象为API，IPBlock-Operator-Plus通过调用API来实现实际的封禁行为。</span><br><span class="line"></span><br><span class="line">目前通过`engine/control.py`​来实现API，接口列表如下：</span><br><span class="line"></span><br><span class="line">| 接口     | 方法 | 说明                                          |</span><br><span class="line">| -------- | ---- | --------------------------------------------- |</span><br><span class="line">| /limit   | GET  | iptables限流接口                              |</span><br><span class="line">| /unlimit | GET  | iptables解限流接口                            |</span><br><span class="line">| /limits  | GET  | iptables查看当前限流情况                      |</span><br><span class="line">| /update  |      | XDP封禁端口                                   |</span><br><span class="line">| /remove  |      | XDP解封禁端口                                 |</span><br><span class="line">| /ban     | GET  | （弃用）可从nginx日志查，返回超过一定次数的IP |</span><br><span class="line">| /execute | GET  | （弃用）接收IP，对其执行XDP封禁               |</span><br><span class="line"></span><br><span class="line">engine支持列表：</span><br><span class="line"></span><br><span class="line">- XDP：依赖于[evilsp/xdp_banner: 一个简单的 XDP 小程序，用于 BAN IP](https://github.com/evilsp/xdp_banner)</span><br><span class="line"></span><br><span class="line">- iptables：依赖于Linux工具iptables。</span><br><span class="line"></span><br><span class="line">  规则为 IP 每分钟最多发起10个新连接（可突发20次），否则DROP</span><br><span class="line"></span><br><span class="line">  ```go</span><br><span class="line">  iptables -A INPUT -s &lt;IP&gt; -p tcp --dport &lt;TARGET_PORT&gt; \</span><br><span class="line">    -m state --state NEW \</span><br><span class="line">    -m hashlimit --hashlimit 10/min --hashlimit-burst 20 \</span><br><span class="line">    --hashlimit-mode srcip --hashlimit-name limit_&lt;IP_REPLACED&gt; \</span><br><span class="line">    -j ACCEPT</span><br><span class="line">  ​</span><br><span class="line">  iptables -A INPUT -s &lt;IP&gt; -p tcp --dport &lt;TARGET_PORT&gt; -j DROP</span><br></pre></td></tr></table></figure>

<h2 id="扩展开发指南"><a href="#扩展开发指南" class="headerlink" title="扩展开发指南"></a><strong>扩展开发指南</strong></h2><p>engine定义了接口，新adapter只需要实现这两个方法即可。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Adapter <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Ban 对某个 IP 发起封禁</span></span><br><span class="line">    <span class="comment">// ip: 要封禁的 IP 地址</span></span><br><span class="line">    <span class="comment">// isParmanent: 是否永久封禁（true 表示永久）</span></span><br><span class="line">    <span class="comment">// durationSeconds: 封禁时长（单位：秒，仅在临时封禁时生效）</span></span><br><span class="line">    Ban(ip <span class="type">string</span>, isParmanent <span class="type">bool</span>, durationSeconds <span class="type">int</span>) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">​</span><br><span class="line">    <span class="comment">// UnBan 解封某个 IP</span></span><br><span class="line">    UnBan(ip <span class="type">string</span>) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line">​</span><br></pre></td></tr></table></figure>

<p>然后在<code>NewAdapter</code>​注册对应的adapter</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAdapter</span><span class="params">(name, gatewayHost <span class="type">string</span>)</span></span> Adapter &#123;</span><br><span class="line">    <span class="keyword">switch</span> name &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;xdp&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;XDPAdapter&#123;GatewayHost: gatewayHost&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;iptables&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;IptablesAdapter&#123;GatewayHost: gatewayHost&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">return</span> &amp;XDPAdapter&#123;GatewayHost: gatewayHost&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着在<code>controller.py</code>​中要实现对应的API，最后在<code>configmap</code>​中<code>engine</code>​字段指定对应的adapter名即可。</p>
<h1 id="notify"><a href="#notify" class="headerlink" title="notify"></a>notify</h1><p>介绍. </p>
<p>notify支持列表：</p>
<ul>
<li>lark：飞书，通过机器人来进行通知</li>
</ul>
<h2 id="扩展开发指南-1"><a href="#扩展开发指南-1" class="headerlink" title="扩展开发指南"></a>扩展开发指南</h2><p>notify定义了接口，新notify只需要实现这个接口即可。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 主计算函数</span></span><br><span class="line"><span class="type">int</span> Calculate(char e[])</span><br><span class="line">&#123;</span><br><span class="line">    numStack OPND = InitNumStack();</span><br><span class="line">    opStack OPTR = InitOpStack();</span><br><span class="line">    PushOp(OPTR, <span class="string">&#x27;#&#x27;</span>);  <span class="comment">// 初始化运算符栈</span></span><br><span class="line"></span><br><span class="line">    char ch, op;</span><br><span class="line">    <span class="type">int</span> a, b, result = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>; <span class="comment">// 检测是否为多位数</span></span><br><span class="line"></span><br><span class="line">    strcat(e, <span class="string">&quot;#&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; e[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ch = e[i];</span><br><span class="line">        <span class="keyword">if</span> (ch &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">            num = num * <span class="number">10</span> + (ch - <span class="string">&#x27;0&#x27;</span>); <span class="comment">// 累加组合成多位数</span></span><br><span class="line">            flag = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(flag) &#123;</span><br><span class="line">                PushNum(OPND, num);  <span class="comment">// 压入操作数</span></span><br><span class="line">                num = <span class="number">0</span>;</span><br><span class="line">                flag = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            while(getPriority(GetOpTop(OPTR), ch) == <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">                PopOp(OPTR, &amp;op);</span><br><span class="line">                PopNum(OPND, &amp;b);</span><br><span class="line">                PopNum(OPND, &amp;a);</span><br><span class="line">                result = Operate(a, b, op);</span><br><span class="line">                PushNum(OPND, result);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getPriority(GetOpTop(OPTR), ch) == <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">                PushOp(OPTR, ch);  <span class="comment">// 压入当前运算符</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getPriority(GetOpTop(OPTR), ch) == <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">                PopOp(OPTR, &amp;op); <span class="comment">// 出栈匹配</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PopNum(OPND, &amp;result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以lark为例，在<code>lark.go</code>​中实现两个方法</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NewLarkNotify 创建一个 LarkNotify（飞书通知器）实例。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 参数:</span></span><br><span class="line"><span class="comment">//   - webhookURL: 飞书群机器人的 Webhook 地址。</span></span><br><span class="line"><span class="comment">//   - templatePaths: 各类通知类型所用的 card 模板路径映射（如 map[&quot;ban&quot;]=&quot;templates/ban.json&quot;）。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 返回值:</span></span><br><span class="line"><span class="comment">//   - 成功: 返回 LarkNotify 实例。</span></span><br><span class="line"><span class="comment">//   - 失败: 返回 error，通常是模板解析失败或配置不合法。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLarkNotify</span><span class="params">(webhookURL <span class="type">string</span>, templatePaths <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> (*LarkNotify, <span class="type">error</span>) &#123;&#125;</span><br><span class="line"><span class="comment">// Notify 实现 Notifier 接口，</span></span><br><span class="line"><span class="comment">// 根据事件类型和变量构造飞书卡片消息，并发送至 webhook。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 参数:</span></span><br><span class="line"><span class="comment">//   - ctx: 请求上下文，用于控制超时和取消等。</span></span><br><span class="line"><span class="comment">//   - eventType: 事件类型（如 &quot;ban&quot;、&quot;resolve&quot;、&quot;error&quot;）。</span></span><br><span class="line"><span class="comment">//   - vars: 模板变量键值对，例如 &#123;&quot;ip&quot;: &quot;1.2.3.4&quot;, &quot;reason&quot;: &quot;恶意连接&quot;&#125;。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 返回值:</span></span><br><span class="line"><span class="comment">//   - 成功: 返回 nil。</span></span><br><span class="line"><span class="comment">//   - 失败: 返回 error，表示通知失败。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LarkNotify)</span></span> Notify(ctx context.Context, eventType <span class="type">string</span>, vars <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>) <span class="type">error</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>最后在<code>main.go</code>​中<code>watchConfigMap</code>​中完善<code>loadNotify</code>​。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    char e[MAXSIZE]; <span class="comment">// 一条表达式 </span></span><br><span class="line">    char p[MAXSIZE][MAXSIZE]; <span class="comment">// 所有表达式</span></span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&quot;输入表达式，每行一个，以\&quot;=\&quot;结束：\n&quot;</span>);</span><br><span class="line">    while(<span class="number">1</span>) &#123;</span><br><span class="line">        gets(e); <span class="comment">// 读取一行表达式</span></span><br><span class="line">        <span class="comment">// 去除换行符</span></span><br><span class="line">        e[strcspn(e,<span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(strcmp(e, <span class="string">&quot;=&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        strcpy(p[count++], e);</span><br><span class="line">    &#125;</span><br><span class="line">    printf(<span class="string">&quot;计算结果为：\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;count; i++) &#123;</span><br><span class="line">        <span class="type">int</span> result = Calculate(p[i]);</span><br><span class="line">        printf(<span class="string">&quot;%d\n&quot;</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>trigger支持列表：</p>
<ul>
<li>grafana：可以 Grafana Alert 联动，通过 Webhook 进行触发。</li>
</ul>
<h2 id="扩展开发指南-2"><a href="#扩展开发指南-2" class="headerlink" title="扩展开发指南"></a>扩展开发指南</h2><h4 id="0-注意新-trigger-在开发时需要考虑并发问题。具体实现可查看-grafana-go-中的处理逻辑，也可参考核心功能模块开发文档中并发处理的逻辑介绍。"><a href="#0-注意新-trigger-在开发时需要考虑并发问题。具体实现可查看-grafana-go-中的处理逻辑，也可参考核心功能模块开发文档中并发处理的逻辑介绍。" class="headerlink" title="{0}注意新 trigger 在开发时需要考虑并发问题。具体实现可查看 grafana.go 中的处理逻辑，也可参考核心功能模块开发文档中并发处理的逻辑介绍。"></a>{0}注意新 trigger 在开发时需要考虑并发问题。具体实现可查看 grafana.go 中的处理逻辑，也可参考核心功能模块开发文档中并发处理的逻辑介绍。</h4><p>trigger同样定义了接口，新trigger只需要实现接口即可。</p>
<h2 id="go"><a href="#go" class="headerlink" title="go"></a>go</h2><p>&#x2F;&#x2F; Trigger 是封禁事件的触发器接口，Start 启动监听任务，Stop 停止监听任务<br>type Trigger interface {<br>    Name() string<br>    Start(ctx context.Context) error<br>    Stop(ctx context.Context) error<br>}</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>trigger在<code>manager.go</code>​中实现了<code>StartAll</code>​和<code>StopAll</code>​，会启动在<code>configmap</code>​中指定的所有trigger。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  triggers:                                          # 触发器，目前仅支持 Grafana</span><br><span class="line">    - name: grafana</span><br><span class="line">      addr: <span class="string">&quot;:8090&quot;</span></span><br><span class="line">      path: <span class="string">&quot;/trigger/grafana&quot;</span></span><br><span class="line">    - name: your_trigger</span><br><span class="line">      other: xxx</span><br></pre></td></tr></table></figure>

<p>trigger自定义的配置字段，在<code>main.go</code>​中进行配置</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Grafana Trigger 示例</span></span><br><span class="line"><span class="keyword">type</span> TriggerConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span> <span class="string">`yaml:&quot;name&quot;`</span></span><br><span class="line">	Addr <span class="type">string</span> <span class="string">`yaml:&quot;addr,omitempty&quot;`</span></span><br><span class="line">	Path <span class="type">string</span> <span class="string">`yaml:&quot;path,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 trigger 字符串为 YAML 列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseTriggers</span><span class="params">(yamlStr <span class="type">string</span>)</span></span> ([]TriggerConfig, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> triggers []TriggerConfig</span><br><span class="line">	err := yaml.Unmarshal([]<span class="type">byte</span>(yamlStr), &amp;triggers)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> triggers, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择触发器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateTriggerByConfig</span><span class="params">(cfg TriggerConfig, mgr ctrl.Manager)</span></span> trigger.Trigger &#123;</span><br><span class="line">	<span class="keyword">switch</span> cfg.Name &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;grafana&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> &amp;trigger.GrafanaTrigger&#123;</span><br><span class="line">			Client: mgr.GetClient(),</span><br><span class="line">			Addr:   cfg.Addr,</span><br><span class="line">			Path:   cfg.Path,</span><br><span class="line">			<span class="comment">// 1000 个 IP， 60 秒防抖</span></span><br><span class="line">			<span class="comment">// LRU中最多保存1000个IP，达到1000个后会自动淘汰最近最少使用的IP</span></span><br><span class="line">			<span class="comment">// 对于同一个IP，如果最近60s内发生过一次封禁，那么这60s内再次收到该IP的相同请求时，会被防抖识别为重复</span></span><br><span class="line">			Debouncer: utils.NewLRUDebouncer(<span class="number">1000</span>, <span class="number">60</span>*time.Second),</span><br><span class="line">			IPLocker:  utils.NewIPLock(),</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">// TODO 其他触发器 ...</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">policy支持功能列表：</span><br><span class="line"></span><br><span class="line">- whitelist：白名单机制</span><br><span class="line"></span><br><span class="line">policy实现比较灵活，下面描述白名单机制的实现流程。</span><br><span class="line"></span><br><span class="line">1. 在`policy/watchlist.go`​中实现三个函数</span><br><span class="line"></span><br><span class="line">   ```go</span><br><span class="line">   // 白名单机制</span><br><span class="line">   // 单IP白名单</span><br><span class="line">   // CIDR白名单</span><br><span class="line">   // 标签匹配</span><br><span class="line">   </span><br><span class="line">   type Whitelist struct &#123;</span><br><span class="line">   	ipNets []*net.IPNet // IPNet的指针切片，保存CIDR网段</span><br><span class="line">   	ips    []net.IP     // 精确IP白名单</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 新建白名单</span><br><span class="line">   func NewWhitelist(ipList []string) *Whitelist &#123;&#125;</span><br><span class="line">   </span><br><span class="line">   // 判断目标IP是否在白名单中</span><br><span class="line">   func (w *Whitelist) IsWhitelisted(ip string) bool &#123;&#125;</span><br><span class="line">   </span><br><span class="line">   // 打印所有白名单内容</span><br><span class="line">   func (w *Whitelist) StringSlice() []string &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>在<code>config/loader.go</code>​中实现一个<code>LoadWhitelistFromConfigMap</code>​，用于加载定义在<code>configmap</code>​中的白名单IP。</p>
</li>
<li><p>在<code>main.go</code>​的<code>watchConfigMap</code>​中来监听白名单的新建和更新情况。</p>
</li>
</ol>
<p>‍</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Yiiong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/">http://example.com/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">Yiiong's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><a class="post-meta__tags" href="/tags/C/">C</a></div><div class="post-share"><div class="social-share" data-image="/img/ava.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/08/%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" title="运维常用工具"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">运维常用工具</div></div><div class="info-2"><div class="info-item-1">Harbor Harbor (goharbor.io)  尽管Docker官方提供了公共的镜像仓库DockerHub，但从安全性和稳定性等方面考虑，部署私有镜像仓库是非常有必要的。Harbor是一个由VMware公司开源的企业级的Docker Registry管理项目，是我们搭建私有镜像仓库的不二之选。 整体架构 如上图所示是 Harbor 2.0 的架构图，从上到下可分为代理层、功能层和数据层。  代理层：代理层实质上是一个 Nginx 反向代理，负责接收不同类型的客户端请求，包括浏览器、用户脚本、Docker 等，并根据请求类型和 URI 转发给不同的后端服务进行处理。 功能层： Portal：是一个基于 Argular 的前端应用，提供 Harbor 用户访问的界面。 Core：是 Harbor 中的核心组件，封装了 Harbor 绝大部分的业务逻辑。 JobService：异步任务组件，负责 Harbor 中很多比较耗时的功能，比如 Artifact 复制、扫描、垃圾回收等。 Docker Distribution：Harbor 通过 Distribution 实现 Ar...</div></div></div></a><a class="pagination-related" href="/2025/12/08/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="数据结构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">数据结构</div></div><div class="info-2"><div class="info-item-1">绪论数据：所有能输入到计算机中并可以被计算机处理的信号。 数据元素：用于完整地描述一个对象，是数据的基本单位。 数据项：组成数据元素的、有独立含义的、不可分割的最小单位。 数据对象：性质相同的数据元素的集合，是数据的一个子集。 数据结构：相互之间存在一个或多种特定关系的数据元素的集合。 逻辑结构：从具体问题抽象出来的数学模型。 存储结构：逻辑结构在计算机中的存储表示。分顺序存储结构和链式存储结构。 抽象数据类型：由用户定义的，表示应用问题的数学模型，以及定义在这个模型上的一组操作的总称。 时间复杂度O(1) &lt; O(logn) &lt; O(n) &lt; O(nlogn) &lt; O(nn) &lt; O(nn*n) O(2的n次方) &lt; O(n!) &lt; O(n的n次方) 冒泡排序 最好时间复杂度：O(n) -&gt; 一轮冒泡就排好 最坏时间复杂度：O(n*n) 线性表顺序表的基本操作顺序表的存储结构 plaintext#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define MAXSIZE 100#...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Yiiong</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Beatrueman" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yiiong@redrock.team" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">扩展开发指南</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#notify"><span class="toc-number">2.</span> <span class="toc-text">notify</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-1"><span class="toc-number">2.1.</span> <span class="toc-text">扩展开发指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trigger"><span class="toc-number">2.1.1.</span> <span class="toc-text">trigger</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">介绍</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-2"><span class="toc-number">2.2.</span> <span class="toc-text">扩展开发指南</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-%E6%B3%A8%E6%84%8F%E6%96%B0-trigger-%E5%9C%A8%E5%BC%80%E5%8F%91%E6%97%B6%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E3%80%82%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%9F%A5%E7%9C%8B-grafana-go-%E4%B8%AD%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%EF%BC%8C%E4%B9%9F%E5%8F%AF%E5%8F%82%E8%80%83%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E4%B8%AD%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%E7%9A%84%E9%80%BB%E8%BE%91%E4%BB%8B%E7%BB%8D%E3%80%82"><span class="toc-number">2.2.1.</span> <span class="toc-text">{0}注意新 trigger 在开发时需要考虑并发问题。具体实现可查看 grafana.go 中的处理逻辑，也可参考核心功能模块开发文档中并发处理的逻辑介绍。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go"><span class="toc-number">2.3.</span> <span class="toc-text">go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.4.</span> <span class="toc-text"></span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/08/redis/" title="Redis主从同步实验">Redis主从同步实验</a><time datetime="2025-12-08T14:55:52.970Z" title="发表于 2025-12-08 22:55:52">2025-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/08/%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" title="运维常用工具">运维常用工具</a><time datetime="2025-12-08T14:00:22.525Z" title="发表于 2025-12-08 22:00:22">2025-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/08/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95/" title="算法记录">算法记录</a><time datetime="2025-12-08T14:00:22.521Z" title="发表于 2025-12-08 22:00:22">2025-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/08/%E5%AE%9E%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Baidu实习总结">Baidu实习总结</a><time datetime="2025-12-08T14:00:22.515Z" title="发表于 2025-12-08 22:00:22">2025-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/08/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="数据结构">数据结构</a><time datetime="2025-12-08T14:00:22.515Z" title="发表于 2025-12-08 22:00:22">2025-12-08</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Yiiong</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script async data-pjax src="/"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>