<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MariaDB Galera错误的更改配置方式导致集群无法拉起 | Yiiong's Blog</title><meta name="author" content="Yiiong"><meta name="copyright" content="Yiiong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="故障描述sre-tools-database 命名空间下由 MariaDB Operator 管理的 Galera 集群包含 3 个 Pod 实例。在一次配置变更过程中，将对应的 StatefulSet 直接缩容至 0，随后再扩容回 3。 扩容后，三个 Pod 均无法进入 Running 状态，集群节点相互等待（死锁），始终无法形成 Primary View，最终因连接超时而启动失败。 mar">
<meta property="og:type" content="article">
<meta property="og:title" content="MariaDB Galera错误的更改配置方式导致集群无法拉起">
<meta property="og:url" content="http://blog.yiiong.top/posts/52501.html">
<meta property="og:site_name" content="Yiiong&#39;s Blog">
<meta property="og:description" content="故障描述sre-tools-database 命名空间下由 MariaDB Operator 管理的 Galera 集群包含 3 个 Pod 实例。在一次配置变更过程中，将对应的 StatefulSet 直接缩容至 0，随后再扩容回 3。 扩容后，三个 Pod 均无法进入 Running 状态，集群节点相互等待（死锁），始终无法形成 Primary View，最终因连接超时而启动失败。 mar">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.yiiong.top/img/ava.jpg">
<meta property="article:published_time" content="2025-12-22T13:07:45.035Z">
<meta property="article:modified_time" content="2025-12-22T13:18:10.249Z">
<meta property="article:author" content="Yiiong">
<meta property="article:tag" content="Trouble Shooting">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.yiiong.top/img/ava.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MariaDB Galera错误的更改配置方式导致集群无法拉起",
  "url": "http://blog.yiiong.top/posts/52501.html",
  "image": "http://blog.yiiong.top/img/ava.jpg",
  "datePublished": "2025-12-22T13:07:45.035Z",
  "dateModified": "2025-12-22T13:18:10.249Z",
  "author": [
    {
      "@type": "Person",
      "name": "Yiiong",
      "url": "http://blog.yiiong.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/logo.svg"><link rel="canonical" href="http://blog.yiiong.top/posts/52501.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const hour = new Date().getHours()
          const isNight = hour <= 6 || hour >= 24
          if (theme === undefined) isNight ? activateDarkMode() : activateLightMode()
          else theme === 'light' ? activateLightMode() : activateDarkMode()
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":"true`"},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Yiiong","link":"链接: ","source":"来源: Yiiong's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'FancyBox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MariaDB Galera错误的更改配置方式导致集群无法拉起',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/universe.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div id="web_bg" style="background: transparent;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/tag.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Yiiong's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">MariaDB Galera错误的更改配置方式导致集群无法拉起</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MariaDB Galera错误的更改配置方式导致集群无法拉起</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-22T13:07:45.035Z" title="发表于 2025-12-22 21:07:45">2025-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-22T13:18:10.249Z" title="更新于 2025-12-22 21:18:10">2025-12-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Trouble-Shooting/">Trouble Shooting</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><meta name="referrer" content="no-referrer"/>

<h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p><code>sre-tools-database</code> 命名空间下由 <strong>MariaDB Operator 管理的 Galera 集群</strong>包含 3 个 Pod 实例。在一次配置变更过程中，将对应的 <strong>StatefulSet 直接缩容至 0</strong>，随后再扩容回 3。</p>
<p>扩容后，三个 Pod 均无法进入 <code>Running</code> 状态，集群节点相互等待（死锁），始终无法形成 <strong>Primary View</strong>，最终因连接超时而启动失败。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mariadb-galera-0日志</span><br><span class="line">...</span><br><span class="line">2025-12-21 14:10:02 0 [Note] WSREP: gcomm: connecting to group <span class="string">&#x27;mariadb-operator&#x27;</span>, peer <span class="string">&#x27;mariadb-galera-0.mariadb-galera-internal.sre-tools-database.svc.cluster.local:,mariadb-galera-1.mariadb-galera-internal.sre-tools-database.svc.cluster.local:,mariadb-galera-2.mariadb-galera-internal.sre-tools-database.svc.cluster.local:&#x27;</span></span><br><span class="line">2025-12-21 14:10:02 0 [Note] WSREP: (be2303ad-b24e, <span class="string">&#x27;tcp://0.0.0.0:4567&#x27;</span>) Found matching <span class="built_in">local</span> endpoint <span class="keyword">for</span> a connection, blacklisting address tcp://100.112.98.78:4567</span><br><span class="line">2025-12-21 14:10:05 0 [Note] WSREP: EVS version upgrade 0 -&gt; 1</span><br><span class="line">2025-12-21 14:10:05 0 [Note] WSREP: PC protocol upgrade 0 -&gt; 1</span><br><span class="line">[*]2025-12-21 14:10:05 0 [Warning] WSREP: no nodes coming from prim view, prim not possible</span><br><span class="line">[*]2025-12-21 14:10:05 0 [Note] WSREP: view(view_id(NON_PRIM,be2303ad-b24e,1) memb &#123;</span><br><span class="line">be2303ad-b24e,0</span><br><span class="line">&#125; joined &#123;</span><br><span class="line">&#125; left &#123;</span><br><span class="line">&#125; partitioned &#123;</span><br><span class="line">&#125;)</span><br><span class="line">2025-12-21 14:10:06 0 [Warning] WSREP: last inactive check more than PT1.5S ago (PT3.50146S), skipping check</span><br><span class="line">2025-12-21 14:10:35 0 [Note] WSREP: PC protocol downgrade 1 -&gt; 0</span><br><span class="line">2025-12-21 14:10:35 0 [Note] WSREP: view((empty))</span><br><span class="line">[*]2025-12-21 14:10:35 0 [ERROR] WSREP: failed to open gcomm backend connection: 110: failed to reach primary view: 110 (Connection timed out)</span><br><span class="line">at ./gcomm/src/pc.cpp:connect():160</span><br><span class="line">2025-12-21 14:10:35 0 [ERROR] WSREP: ./gcs/src/gcs_core.cpp:gcs_core_open():221: Failed to open backend connection: -110 (Connection timed out)</span><br><span class="line">2025-12-21 14:10:36 0 [ERROR] WSREP: ./gcs/src/gcs.cpp:gcs_open():1674: Failed to open channel <span class="string">&#x27;mariadb-operator&#x27;</span> at <span class="string">&#x27;gcomm://mariadb-galera-0.mariadb-galera-internal.sre-tools-database.svc.cluster.local,mariadb-galera-1.mariadb-galera-internal.sre-tools-database.svc.cluster.local,mariadb-galera-2.mariadb-galera-internal.sre-tools-database.svc.cluster.local&#x27;</span>: -110 (Connection timed out)</span><br><span class="line">[*]2025-12-21 14:10:36 0 [ERROR] WSREP: gcs connect failed: Connection timed out</span><br><span class="line">2025-12-21 14:10:36 0 [ERROR] WSREP: wsrep::connect(gcomm://mariadb-galera-0.mariadb-galera-internal.sre-tools-database.svc.cluster.local,mariadb-galera-1.mariadb-galera-internal.sre-tools-database.svc.cluster.local,mariadb-galera-2.mariadb-galera-internal.sre-tools-database.svc.cluster.local) failed: 7</span><br><span class="line">[*]2025-12-21 14:10:36 0 [ERROR] Aborting</span><br><span class="line">root@Redrock-ButterBeer:/var/lib/mysql#</span><br></pre></td></tr></table></figure>

<h1 id="故障原因分析"><a href="#故障原因分析" class="headerlink" title="故障原因分析"></a>故障原因分析</h1><h2 id="直接原因：-不当的运维操作导致-Galera-集群状态完全丢失"><a href="#直接原因：-不当的运维操作导致-Galera-集群状态完全丢失" class="headerlink" title="**直接原因：**不当的运维操作导致 Galera 集群状态完全丢失"></a>**直接原因：**不当的运维操作导致 Galera 集群状态完全丢失</h2><p>在修改数据库配置时，直接编辑了下游的 <code>ConfigMap</code>，并试图通过 <strong>将 StatefulSet 缩容至 0 再扩容</strong> 的方式强制使配置生效。</p>
<p>该操作等同于同时下线所有Galera节点，即终止集群。</p>
<blockquote>
<p>@<a href="mention://0f8566e2-d4e6-497d-8e2f-45fb4890a233/url/d32a8931-d64d-45c8-a442-3c3e74ae5cc4">https://mariadb.com/docs/galera-cluster/galera-management/installation-and-deployment/getting-started-with-mariadb-galera-cluster#restarting-the-cluster</a> </p>
<p>If you shut down all nodes at the same time, then you have effectively terminated the cluster. Of course, the cluster’s data still exists, but the running cluster no longer exists. When this happens, you’ll need to bootstrap the cluster again.</p>
</blockquote>
<p>导致</p>
<ul>
<li>集群中不存在任何存活节点可作为 <strong>Primary Component</strong></li>
<li>没有节点持有可用于恢复的有效集群视图（View）</li>
<li>所有节点在启动时都在等待其他节点先行加入，形成”相互等待”的死锁状态</li>
</ul>
<p>最终集群无法自动选主，全部节点启动失败。</p>
<h2 id="深层原因"><a href="#深层原因" class="headerlink" title="深层原因"></a><strong>深层原因</strong></h2><ol>
<li>**绕过了Operator的声明式管理逻辑：**没有意识到由Operator管理的资源，应该通过修改上层CR的Spec来触发Operator的Reconcile逻辑，而不是直接修改干预下层资源（ConfigMap、StatefulSet），导致 Operator 无法自动识别集群的故障状态并触发内置的故障恢复逻辑。</li>
<li>**缺乏测试验证：**进行高风险破环性更新（即同时停止所有数据库实例）前应该先测试，违反了运维操作规范。不过幸好有备份。</li>
<li>**容灾建设不完善：**没有集群恢复的标准SOP，对于故障发生后也只能依赖临时排障+文档查阅，恢复成本高，时间周期长。</li>
</ol>
<h1 id="故障发生时间线"><a href="#故障发生时间线" class="headerlink" title="故障发生时间线"></a>故障发生时间线</h1><ul>
<li><p>2025&#x2F;12&#x2F;21 21:40</p>
<p>由于 <strong>SRE_center</strong> 数据库的 <strong>change_info</strong> 表在插入中文数据后显示为拉丁字符，排查发现 <code>character-set-server</code> 为 <code>latin</code>，因此决定调整为 <code>utf8mb4</code>。\n通过以下命令修改 MariaDB Galera 的配置 ConfigMap：</p>
<p><code>kubectl edit cm -n sre-tools-database mariadb-galera-config </code></p>
<p>新增配置内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mariadb]</span><br><span class="line">character-set-server=utf8mb4 </span><br><span class="line">collation-server=utf8mb4_general_ci </span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<ul>
<li><p>2025&#x2F;12&#x2F;21 21:50</p>
<p>修改配置后，对 <code>mariadb-galera</code> StatefulSet 进行操作，<strong>直接缩容至 0，再扩容至 3</strong>。\n新启动的 Pod 无法正常进入 <code>Running</code> 状态，Pod 日志中报错（详见故障描述）。\n3 个 Pod 无法完成选主，集群进入死锁状态。</p>
</li>
</ul>
<hr>
<ul>
<li><p>2025&#x2F;12&#x2F;21 22:00</p>
<p>查阅官方文档及相关资料后确认：\n当 Galera 集群被整体终止后，需要人工介入重新引导集群。</p>
<p>恢复思路为：</p>
<ul>
<li>先启动一个节点作为 <strong>Most Advanced Node</strong></li>
<li>再由其他节点加入该集群</li>
</ul>
<p>因此将 StatefulSet 缩容至 1，尝试启动 Pod 0。</p>
</li>
</ul>
<hr>
<ul>
<li><p>2025&#x2F;12&#x2F;21 23:44</p>
<p>操作时先暂停Operator对MariaDB集群的管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch mariadb mariadb-galera -n sre-tools-database \</span><br><span class="line">  --<span class="built_in">type</span> merge -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;suspend&quot;:true&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>通过修改 Pod 0 对应 PV 中 <code>/var/lib/mysql/grastate.dat</code> 文件，将 <code>safe_to_bootstrap</code> 设置为 <code>1</code>，并在 StatefulSet 中为 mariadb 容器添加启动参数 <code>mariadbd --wsrep_new_cluster</code>，成功使 Pod 0 正常启动。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GALERA saved state</span></span><br><span class="line">version: 2.1</span><br><span class="line">uuid:    0a9026bb-de80-11f0-aa0c-7ec0fff494fd</span><br><span class="line">seqno:   -1</span><br><span class="line">safe_to_bootstrap: 1</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<ul>
<li><p>2025&#x2F;12&#x2F;21 23:50</p>
<p>对 Pod 1、Pod 2 也采用了相同方式进行启动。\n但该操作会导致每个 Pod 都被视为独立集群，形成集群脑裂，不符合主从架构。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;wsrep_cluster_size&#x27;</span>;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| wsrep_cluster_size | 1     |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<ul>
<li><p>2025&#x2F;12&#x2F;22 00:01</p>
<p>删除 Pod 1、Pod 2 对应 PV 中的 <code>grastate.dat</code> 文件，\n并移除 StatefulSet 中的 <code>--wsrep_new_cluster</code> 启动参数，随后重新启动这两个 Pod。</p>
<p>Pod 正常 <code>Running</code> 后，检查集群状态：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="string">&#x27;wsrep_cluster_size&#x27;</span>;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| wsrep_cluster_size | 3     |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>

<p>恢复Operator对MariaDB的管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch mariadb mariadb-galera -n sre-tools-database \</span><br><span class="line">    --<span class="built_in">type</span> merge -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;suspend&quot;:false&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>集群恢复正常，服务功能恢复。</p>
</li>
</ul>
<h1 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h1><p>见MariaDB Galera容器集群恢复方法</p>
<h1 id="改进措施"><a href="#改进措施" class="headerlink" title="改进措施"></a>改进措施</h1><ul>
<li>如果是Operator管理的资源，请通过修改对应CR（Custom Resource）来修改某些配置，避免Operator与人工操作发生冲突。</li>
<li>永远不要把Galera集群StatefulSet的replicas设置为0，另外也<strong>禁止缩容操作</strong>。</li>
<li>Galera集群必须保证(N&#x2F;2) + 1在线。3节点必须保证2个节点在线，否则将无法完成选主并进入不可用状态。</li>
<li>优先使用滚动更新<code>kubectl rollout restart</code>，避免一次性中断所有节点。</li>
<li>某些破坏性变更应该先进行测试，操作时要想清楚会发生什么后果。</li>
<li>关于运维操作（如配置修改、扩缩容、重启）应做好 <strong>操作记录与时间点标记（ButterBeer已打开history时间记录）</strong>，便于事后审计与问题回溯。</li>
</ul>
<blockquote>
<ul>
<li>Operator原理<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/operator/</a></li>
</ul>
</li>
<li>MariaDB grastate.dat</li>
<li>MariaDB集群引导：<a target="_blank" rel="noopener" href="https://mariadb.com/docs/galera-cluster/high-availability/resetting-the-quorum-cluster-bootstrap#find-the-most-advanced-node">https://mariadb.com/docs/galera-cluster/high-availability/resetting-the-quorum-cluster-bootstrap#find-the-most-advanced-node</a></li>
<li>MariaDB恢复：<a target="_blank" rel="noopener" href="https://mariadb.com/docs/galera-cluster/high-availability/understanding-quorum-monitoring-and-recovery#recovering-from-a-full-cluster-shutdown">https://mariadb.com/docs/galera-cluster/high-availability/understanding-quorum-monitoring-and-recovery#recovering-from-a-full-cluster-shutdown</a></li>
</ul>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://blog.yiiong.top">Yiiong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://blog.yiiong.top/posts/52501.html">http://blog.yiiong.top/posts/52501.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://blog.yiiong.top" target="_blank">Yiiong's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Trouble-Shooting/">Trouble Shooting</a></div><div class="post-share"><div class="social-share" data-image="/img/ava.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/65364.html" title="运维变更规范"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">运维变更规范</div></div><div class="info-2"><div class="info-item-1">  目的为规范运维人员的变更行为，降低变更风险，提升整体运维质量，特制定本变更规范。 变更本身具有不确定性，每一次变更都可能对系统稳定性和业务连续性产生影响。在缺乏统一记录和规范流程的情况下，一旦出现问题，往往需要多名成员临时介入排查，信息不对称，责任边界模糊，最终只能被动兜底。 因此，我们通过 Redrock Horizon 平台发起变更单 的方式，对每一次变更进行记录和管理，使变更过程可追溯、可评估、可复盘。 同时，完整地编写变更单，有助于运维人员在变更前进行系统性思考，这对于培养全局视角和风险意识具有长期价值。  发起变更单  变更分类技术变更主要面向 SRE 的系统操作 以及 研发人员的代码发布行为。 包括但不限于：  涉及代码部署、服务启停、服务升级等底层系统操作 日常版本发布（功能迭代、热修复、补丁更新等） 基础资源调整（服务器扩容、网络架构变更、存储资源配置等）   运营变更主要指 由 SRE 发起的策略或参数调整类操作。 包括但不限于：  通过后台管理系统实施的操作（如向 WAF 黑名单添加 IP 等） 业务规则或策略配置更新（如风控阈值、安全封禁参数调整，服务配...</div></div></div></a><a class="pagination-related" href="/posts/52500.html" title="MariaDB Galera容器集群恢复方法"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">MariaDB Galera容器集群恢复方法</div></div><div class="info-2"><div class="info-item-1">      MariaDB集群引导：https://mariadb.com/docs/galera-cluster/high-availability/resetting-the-quorum-cluster-bootstrap#find-the-most-advanced-node MariaDB恢复：https://mariadb.com/docs/galera-cluster/high-availability/understanding-quorum-monitoring-and-recovery#recovering-from-a-full-cluster-shutdown   当集群出现崩溃时，可以通过下面的方法来恢复集群。 整体思路 先启动一个节点作为 Most Advanced Node 再由其他节点加入该集群  操作步骤手动指定一个Pod为Most Advanced Node暂停Operator对集群的接管kubectl patch mariadb mariadb-galera -n sre-tools-database \    --type merge -p...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/52500.html" title="MariaDB Galera容器集群恢复方法"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-22</div><div class="info-item-2">MariaDB Galera容器集群恢复方法</div></div><div class="info-2"><div class="info-item-1">      MariaDB集群引导：https://mariadb.com/docs/galera-cluster/high-availability/resetting-the-quorum-cluster-bootstrap#find-the-most-advanced-node MariaDB恢复：https://mariadb.com/docs/galera-cluster/high-availability/understanding-quorum-monitoring-and-recovery#recovering-from-a-full-cluster-shutdown   当集群出现崩溃时，可以通过下面的方法来恢复集群。 整体思路 先启动一个节点作为 Most Advanced Node 再由其他节点加入该集群  操作步骤手动指定一个Pod为Most Advanced Node暂停Operator对集群的接管kubectl patch mariadb mariadb-galera -n sre-tools-database \    --type merge -p...</div></div></div></a><a class="pagination-related" href="/posts/48620.html" title="红岩打印姬复活记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-08</div><div class="info-item-2">红岩打印姬复活记录</div></div><div class="info-2"><div class="info-item-1"> 下面记录一下在复活网校打印机机器人-**红岩打印姬**时遇到的问题和解决方案  做出的更新1.使用了Helemet-CI进行镜像打包 2.更改了Dockerfile的内容，使镜像可以快速且正确的被打包 3.由于飞书接收消息接口的json接收体发生了改变，对reply.py中的file_name、file_key和image_key三个变量的获取造成了影响，使用json.loads()函数解决 1.读取环境变量问题机器人通过configmap读取app_id，app_secret等环境变量，没有configmap的话机器人会报以下错误 Traceback (most recent call last):  File &quot;/nonebot/bot.py&quot;, line 22, in &lt;module&gt;    driver.register_adapter(FeishuAdapter)  File &quot;/usr/local/lib/python3.10/dist-packages/nonebot/internal/driver/abstract.py...</div></div></div></a><a class="pagination-related" href="/posts/23988.html" title="关于GZCTF反向代理配置不当导致平台在高并发下崩溃"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-08</div><div class="info-item-2">关于GZCTF反向代理配置不当导致平台在高并发下崩溃</div></div><div class="info-2"><div class="info-item-1"> ## 环境  GZCTF单实例部署在172.20.14.20、172.20.14.110、172.20.14.111三台机器的K8s集群上，使用LoadBalancer对外暴露服务，LoadBalancer IP由MetalLB分得：172.20.14.118 问题描述2024年11月16日，2024 Redrock CTF开赛，这次比赛使用了新的比赛平台GZ::CTF - GZ::CTF Docs。 由于反向代理配置不当，导致平台在刚开赛时就因为高并发而立即崩溃，报错显示错误代码429，并且平台响应很慢，无法正常刷新。   排查过程在遇到429问题后，首先是检查了配置文件中和访问限制有关的参数配置，都适当的调大，发现并没有什么改善，没有解决问题。  GZCTF是单实例部署的，为了让流量分流，我将Pod扩容，但是单实例部署与多实例部署存在差别，并且据官方介绍单实例已经能满足大部分的一般比赛（满足2000人200题），并且是官方最为推荐的部署方式。多实例部署需要配置对象存储，否则会导致数据不一致的问题。  最后在咨询开发者以及在检查日志的过程中发现了问题： 配置文件中的Forwa...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Yiiong</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Beatrueman"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:yiiong@redrock.team" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Study in Redrock SRE!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">故障描述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">故障原因分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%8E%9F%E5%9B%A0%EF%BC%9A-%E4%B8%8D%E5%BD%93%E7%9A%84%E8%BF%90%E7%BB%B4%E6%93%8D%E4%BD%9C%E5%AF%BC%E8%87%B4-Galera-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E5%AE%8C%E5%85%A8%E4%B8%A2%E5%A4%B1"><span class="toc-number">2.1.</span> <span class="toc-text">**直接原因：**不当的运维操作导致 Galera 集群状态完全丢失</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%B1%82%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.2.</span> <span class="toc-text">深层原因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%8F%91%E7%94%9F%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="toc-number">3.</span> <span class="toc-text">故障发生时间线</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">解决方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E6%8E%AA%E6%96%BD"><span class="toc-number">5.</span> <span class="toc-text">改进措施</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/16924.html" title="Redrock Horizon｜一站式运维平台">Redrock Horizon｜一站式运维平台</a><time datetime="2025-12-25T14:42:14.335Z" title="发表于 2025-12-25 22:42:14">2025-12-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/65364.html" title="运维变更规范">运维变更规范</a><time datetime="2025-12-25T14:37:50.490Z" title="发表于 2025-12-25 22:37:50">2025-12-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/52501.html" title="MariaDB Galera错误的更改配置方式导致集群无法拉起">MariaDB Galera错误的更改配置方式导致集群无法拉起</a><time datetime="2025-12-22T13:07:45.035Z" title="发表于 2025-12-22 21:07:45">2025-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/52500.html" title="MariaDB Galera容器集群恢复方法">MariaDB Galera容器集群恢复方法</a><time datetime="2025-12-22T13:07:45.014Z" title="发表于 2025-12-22 21:07:45">2025-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/18658.html" title="Redis主从同步实验">Redis主从同步实验</a><time datetime="2025-12-08T14:55:52.970Z" title="发表于 2025-12-08 22:55:52">2025-12-08</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Yiiong</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script async data-pjax src="/"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>